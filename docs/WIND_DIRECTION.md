# Документация по направлению ветра

## Обзор

Данный документ объясняет, как работает отображение направления ветра в приложении JollyKite и какие данные поступают из API.

## Источники данных

### 1. AmbientWeather API
**Endpoint:** `https://lightning.ambientweather.net/devices?public.slug=e63ff0d2119b8c024b5aad24cc59a504`

**Данные о направлении:**
- `winddir` - мгновенное направление ветра (градусы)
- `winddir_avg10m` - среднее направление за 10 минут (градусы)

### 2. Open-Meteo API
**Endpoint:** `https://api.open-meteo.com/v1/forecast`

**Данные о направлении:**
- `wind_direction_10m` - прогноз направления ветра на высоте 10м (градусы)

## Метеорологическая конвенция

**ВАЖНО:** Оба API возвращают направление ветра согласно метеорологической конвенции:

- **Значение в градусах указывает направление, ОТКУДА дует ветер**
- 0° / 360° = Северный ветер (дует С СЕВЕРА на юг)
- 90° = Восточный ветер (дует С ВОСТОКА на запад)
- 180° = Южный ветер (дует С ЮГА на север)
- 270° = Западный ветер (дует С ЗАПАДА на восток)

### Примеры:
```
45° = Северо-восточный ветер (дует с северо-востока на юго-запад)
135° = Юго-восточный ветер (дует с юго-востока на северо-запад)
225° = Юго-западный ветер (дует с юго-запада на северо-восток) ← OFFSHORE для нашего спота
315° = Северо-западный ветер (дует с северо-запада на юго-восток) ← OFFSHORE для нашего спота
```

## Отображение на карте

### SVG стрелка
Стрелка в файле `WindArrowController.js` (строки 14-34) направлена **вверх** в исходном состоянии:
```svg
<path d="M 30 5 L 40 25 L 35 25 L 35 50 L 25 50 L 25 25 L 20 25 Z" ... />
```
- Острие находится в точке Y=5 (вверху)
- Основание в точке Y=50 (внизу)
- Центр в точке (30, 30)

### Поворот стрелки
```javascript
element.style.transform = `rotate(${this.windDirection}deg)`;
```

**Логика поворота:**
- Стрелка поворачивается на угол, полученный напрямую из API
- 0° = стрелка направлена вверх (на север) = ветер дует С СЕВЕРА
- 90° = стрелка направлена вправо (на восток) = ветер дует С ВОСТОКА
- 180° = стрелка направлена вниз (на юг) = ветер дует С ЮГА
- 270° = стрелка направлена влево (на запад) = ветер дует С ЗАПАДА

### Позиционирование
```javascript
const arrowPosition = kiterLocation; // [lat, lon]
```

Стрелка размещается **строго в центре** позиции кайтера без каких-либо смещений. Центрирование обеспечивается параметром:
```javascript
iconAnchor: [30, 30] // центр иконки 60x60
```

## Безопасность ветра для кайтинга

### Определение типов ветра (WindDataManager.js, строки 97-100)

```javascript
// Безопасный оффшорный ветер: 225°-315° (ЮЗ-СЗ)
const isOffshore = (dir >= 225 && dir <= 315);

// Опасный оншорный ветер: 45°-135° (СВ-ЮВ)
const isOnshore = (dir >= 45 && dir <= 135);
```

### Offshore (оффшорный) - безопасный для кайтинга
- **Диапазон:** 225° - 315°
- **Направления:** Юго-Западный → Западный → Северо-Западный
- **Характеристика:** Ветер дует С БЕРЕГА В МОРЕ
- **Почему безопасно:** Если возникнут проблемы, кайтера отнесет к берегу

### Onshore (оншорный) - опасный для кайтинга
- **Диапазон:** 45° - 135°
- **Направления:** Северо-Восточный → Восточный → Юго-Восточный
- **Характеристика:** Ветер дует С МОРЯ НА БЕРЕГ
- **Почему опасно:** Если возникнут проблемы, кайтера может отнести в море

### Sideshore (боковой)
- **Остальные направления:** 135°-225° (южный сектор) и 315°-45° (северный сектор)
- **Характеристика:** Ветер дует вдоль берега

## Локальная корректировка

После развертывания отрефакторенной версии можно добавить **локальную корректировку** на основе реальных наблюдений на споте:

```javascript
// Пример корректировки (если потребуется)
const localCorrection = -15; // градусов
element.style.transform = `rotate(${this.windDirection + localCorrection}deg)`;
```

**Важно:** Корректировка должна быть единой для всех направлений и основываться на реальных измерениях на местности, сравнивая показания API с физическими наблюдениями.

## Тестирование

Для проверки корректности отображения используйте функцию симуляции в прогнозах:
1. Нажмите на любую карточку прогноза
2. Проверьте, что стрелка:
   - Остается в центре маркера кайтера
   - Поворачивается согласно направлению
   - Не смещается при переключении между разными направлениями

### Тестовые значения для проверки:
- **0°** - стрелка вверх (север)
- **90°** - стрелка вправо (восток)
- **180°** - стрелка вниз (юг)
- **270°** - стрелка влево (запад)
- **225°** - стрелка вниз-влево (юго-запад) - offshore
- **45°** - стрелка вверх-вправо (северо-восток) - onshore

## Изменения в рефакторинге

### Что было удалено:
1. ✅ Логика смещения позиции стрелки в зависимости от offshore/onshore
2. ✅ Корректировки направления (+180° для onshore)
3. ✅ Переменная `arrowDistance` и расчеты смещения
4. ✅ Дополнительное использование `rotationAngle` в параметрах маркера

### Что добавлено:
1. ✅ Флаг `isInitialized` для предотвращения отображения стрелки до получения данных из API
2. ✅ Проверка инициализации в методе `updateArrow()`
3. ✅ Установка флага в `true` при первом вызове `updateWind()`

### Что оставлено:
1. ✅ Чистое направление из API (`windDirection`)
2. ✅ Центрированное позиционирование на маркере кайтера
3. ✅ Прямой поворот через CSS transform
4. ✅ Цветовое кодирование безопасности

## Исправление проблем

### Проблема: Стрелка появляется в позиции [0, 0] при загрузке
**Причина:** При инициализации `windDirection` и `windSpeed` равны 0, и стрелка создавалась до получения данных из API.

**Решение:** Добавлен флаг `isInitialized`, который устанавливается в `true` только после первого вызова `updateWind()`. Стрелка не отображается до тех пор, пока не придут реальные данные.

## Файлы проекта

- **WindArrowController.js** - основная логика отображения стрелки
- **WindDataManager.js** - получение данных из API и определение безопасности
- **App.js** - интеграция и обновление данных
- **ForecastManager.js** - отображение прогнозов с функцией симуляции
